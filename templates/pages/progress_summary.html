{% extends "base.html" %}
{% from 'pages/_macros.html' import min_to_hrs, back_button , min_to_hrs_label %}
{% block content %}



<div class="dark:text-gray-100 max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8 bg-white rounded-lg shadow">
  <h1 class="text-3xl font-bold text-gray-800 mb-6">Season Progress Summary</h1>
{% if summary_report and summary_report[0].season_start %}
  <p class="text-sm text-gray-600">
    Season: {{ summary_report[0].season_start.strftime('%d %b %Y') }} to {{ summary_report[0].season_end.strftime('%d %b %Y') }}
  </p>
{% else %}
  <p class="text-sm text-red-600">âš ï¸ No summary data available</p>
{% endif %}

  <p class="text-gray-600 mb-6">Total Employees: {{ summary_report | length }}</p>
  <p class="text-gray-600 mb-2">
    ğŸ“ˆ Expected Pace: <span class="font-semibold text-blue-700">{{ avg_expected_pct }}%</span>
  </p>



  <div class="mb-6 w-full h-2 bg-gray-300 rounded">
    <div class="h-2 bg-gray-600 rounded transition-all duration-500" style="width: {{ avg_expected_pct }}%;"></div>
  </div>

<div class="flex gap-4 mb-6">
  <a href="?sort=makeup" class="px-3 py-1 rounded bg-red-100 text-red-700 font-medium hover:bg-red-200 {% if sort == 'makeup' %}ring-2 ring-red-400{% endif %}">
    ğŸ” Most Behind
  </a>
  <a href="?sort=progress" class="px-3 py-1 rounded bg-green-100 text-green-700 font-medium hover:bg-green-200 {% if sort == 'progress' %}ring-2 ring-green-400{% endif %}">
    ğŸ“ˆ Most Ahead
  </a>
  <a href="?sort=ontrack" class="px-3 py-1 rounded bg-gray-100 text-gray-700 font-medium hover:bg-gray-200 {% if sort == 'ontrack' %}ring-2 ring-gray-400{% endif %}">
    â¸ï¸ On Track
  </a>
</div>
<form method="get" class="mb-6 flex flex-wrap items-center gap-4">
  <input type="hidden" name="sort" value="{{ sort }}">
  <label for="dept" class="text-sm text-gray-700 font-medium">Department:</label>
  <select name="dept" id="dept" onchange="this.form.submit()" class="px-3 py-2 rounded border border-gray-300 text-gray-800 bg-white shadow-sm">
    <option value="" {% if not dept %}selected{% endif %}>All</option>
    {% for d in departments %}
      <option value="{{ d }}" {% if dept == d %}selected{% endif %}>{{ d }}</option>
    {% endfor %}
  </select>

  <label for="shift" class="text-sm text-gray-700 font-medium">Shift:</label>
  <select name="shift" id="shift" onchange="this.form.submit()" class="px-3 py-2 rounded border border-gray-300 text-gray-800 bg-white shadow-sm">
    <option value="" {% if not shift %}selected{% endif %}>All</option>
    {% for s in shifts %}
      <option value="{{ s }}" {% if shift == s %}selected{% endif %}>{{ s }}</option>
    {% endfor %}
  </select>
</form>


<!-- Department Filter 
  <h2 class="text-xl font-semibold text-gray-700 mb-4">
  {% if dept %}
    Showing Department: <span class="text-blue-700">{{ dept }}</span>
  {% else %}
    Showing All Departments
  {% endif %}
  </h2>
  -->
<h2 class="text-xl font-semibold text-gray-700 mb-4">
  {% if sort == 'progress' %}
    Showing Top Performers
  {% elif sort == 'ontrack' %}
    Showing Employees On Track
  {% else %}
    Showing Most Behind
  {% endif %}
</h2>

  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
    {% for emp in summary_report %}
      {% if 'Error' in emp %}
        <div class="bg-red-50 border border-red-200 rounded-lg p-4 shadow">
          <h2 class="text-lg font-semibold text-red-700 mb-2">âš ï¸ {{ emp['employee'] }}</h2>
          <p class="text-sm text-red-600">Error loading data: {{ emp['Error'] }}</p>
        </div>
      {% else %}
        <div class="bg-white border border-gray-200 rounded-lg p-4 shadow hover:shadow-lg hover:scale-[1.02] transition-transform duration-200">

          <h2 class="text-lg font-semibold text-blue-700 mb-2">ğŸ‘¤ {{ emp['employee'] }}</h2>

        <table class="w-full text-sm text-gray-700 border-separate border-spacing-y-1">
          <tbody>
            <tr>
              <td class="text-center">âœ…</td>
              <td class="text-left">Done:</td>
              <td class="text-right font-mono text-blue-900 font-semibold">{{ min_to_hrs_label(emp['minsSoFar']) }}</td>

            </tr>
            <tr>
              <td class="text-center">â³</td>
              <td class="text-left">Left:</td>
              <td class="text-right font-mono text-blue-900 font-semibold">{{ min_to_hrs_label(emp['minsRemaining']) }}</td>
            </tr>
            <tr>
              <td class="text-center">ğŸ”</td>
              <td class="text-left">Makeup:</td>
              <td class="text-right font-mono text-blue-900 font-semibold">{{ min_to_hrs_label(emp['makeup']) }}</td>
            </tr>
            <tr>
              <td class="text-center">â•</td>
              <td class="text-left">Extra Shifts:</td>
              <td class="text-right font-mono text-blue-900 font-semibold">{{ emp['xtraShift'] }}</td>
            </tr>
            <tr>
              <td class="text-center">ğŸ¯</td>
              <td class="text-left">Target:</td>
              <td class="text-right font-mono text-blue-900 font-semibold">{{ min_to_hrs_label(emp['totaltodo']) }}</td>
            </tr>
          </tbody>
        </table>


          <div class="mt-4 space-y-2">
            <div class="mt-4">
              <label class="block text-xs text-gray-500 mb-1">ğŸ“Š Progress vs Expected</label>
              <div class="relative w-full h-3 bg-gray-200 rounded overflow-hidden" title="Blue = actual progress, Red = expected pace">
                <!-- Expected Pace -->
                <div class="absolute top-0 left-0 h-3 bg-red-400 rounded transition-all duration-500" style="width: {{ emp['expectedPct'] }}%;"></div>
                <!-- Actual Progress -->
                {% if emp['trend'] == 'ahead' %}
                  <div class="absolute top-0 left-0 h-3 bg-green-500 rounded transition-all duration-500" style="width: {{ emp['progressPct'] }}%;"></div>
                {% else %}
                  <div class="absolute top-0 left-0 h-3 bg-blue-500 rounded transition-all duration-500" style="width: {{ emp['progressPct'] }}%;"></div>
                {% endif %}
              </div>
              <div class="flex justify-between text-xs text-gray-600 mt-1">
                <span>Expected: {{ emp['expectedPct'] }}%</span>
                <span>Actual: {{ emp['progressPct'] }}%</span>
              </div>
            </div>
          </div>
            {% if emp['trend'] == 'ahead' %}
              <span class="inline-block px-2 py-1 rounded-full bg-green-100 text-green-800 font-medium">ğŸ“ˆ Ahead of Pace</span>
            {% elif emp['trend'] == 'behind' %}
              <span class="inline-block px-2 py-1 rounded-full bg-red-100 text-red-800 font-medium">ğŸ“‰ Behind Pace</span>
            {% else %}
              <span class="inline-block px-2 py-1 rounded-full bg-gray-100 text-gray-800 font-medium">â¸ï¸ On Track</span>
            {% endif %}
            <!--
              <div class="mt-4">
                <label class="block text-xs text-gray-500 mb-1">ğŸ“† Last 4 weeks</label>
                <ul class="text-xs text-gray-700 space-y-1">
                  {% for snap in emp.cycle_snapshots %}
                    <li>
                      {{ snap.start.strftime('%d %b') }}â€“{{ snap.end.strftime('%d %b') }}:
                      <span class="{% if snap.pct >= 100 %}text-green-600{% elif snap.pct >= 90 %}text-gray-700{% else %}text-red-600{% endif %}">
                        {{ [snap.pct, 100]|min }}%
                      </span>
                    </li>
                  {% endfor %}
                </ul>
              </div>
            
              {% set recent = emp.cycle_snapshots[0].pct %}
              {% set previous = emp.cycle_snapshots[1].pct %}
              {% if recent > previous %}
                <span class="text-green-600 text-xs">â¬† Improving</span>
              {% elif recent < previous %}
                <span class="text-red-600 text-xs">â¬‡ Slipping</span>
              {% else %}
                <span class="text-gray-600 text-xs">â¸ï¸ Steady</span>
              {% endif %}
              -->



        </div>
      {% endif %}
    {% endfor %}
  </div>

  <div class="flex justify-center mt-10">
    <button onclick="window.print()" class="no-print items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow transition duration-200">
      ğŸ–¨ï¸ Print This
    </button>
  </div>
</div>
<!-- playing    -->


{{ back_button() }}
{% endblock %}