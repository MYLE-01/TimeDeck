{% extends "base.html" %}
{% from 'pages/_macros.html' import back_button, manager_OK_leave %}
{% block content %}

{% set wants_emp_id = emp_id %}
{% for date, data in suggestions_by_date.items() %}
{% set source = data.source %}
{% set first = suggestions_by_date|dictsort if suggestions_by_date else [] %}
{% if first %}
  {% set source = first[0][1].source %}
  <h2 class="text-xl font-bold mb-6">
    Suggested Covers for {{ emp_name }}'s
    {% if source == "sick" %}Sick Leave{% else %}Leave{% endif %}
  </h2>
{% endif %}

{% if data.shift_type == "Night" %}
{% set class = "bg-blue-200"%}
{%else%}
{% set class = "bg-yellow-200"%}
{% endif %}
  <div class="border rounded-lg p-4 mb-6 shadow-sm bg-white">
    <h3 class="text-lg font-semibold text-gray-800 ">
      {{ datetime.strptime(date, '%Y-%m-%d').strftime('%A %d %B') }}
      <span class="text-sm text-gray-500 {{class}}"> ({{ data.shift_type }} shift) </span>
    </h3>

    {% if data.suggestions %}
      <table class="min-w-full mt-3 border-separate border-spacing-y-2">
        <thead>
          <tr class="text-left text-sm text-gray-600">
            <th class="px-4 py-2">Name</th>
            <th class="px-4 py-2">Prefers</th>
            <th class="px-4 py-2">Actions</th>
            <th class="px-4 py-2">Manager Override</th>
          </tr>
        </thead>
        <tbody>

          {%set shift_cover = data.shift_cover %}
          {% for emp_id, name, shift, off_day_count in data.suggestions %}
            {% set declined = emp_id in data.decline_by %}
            <tr class="bg-gray-50 hover:bg-gray-100 transition">
              <td class="px-4 py-2">
                <div>{{ name }}</div>
                {% if off_day_count >= 1 %}
                  <div class="text-green-600 text-xs mt-1">
                    ðŸŸ¢ {{ off_day_count }}
                    {% if off_day_count == 1 %}st{% elif off_day_count == 2 %}nd{% elif off_day_count == 3 %}rd{% else %}th{% endif %}
                    day off â€” rested
                  </div>
                {% else %}
                  <div class="text-red-500 text-xs mt-1">ðŸ”´ Worked recently </div>
                {% endif %}
              </td>
              <td class="px-4 py-2">{{ shift }}</td>
              <td class="px-4 py-2">
                {% if declined %}
                  <span class="text-red-500 text-xs font-semibold">Has declined it</span>
                {% else %}
                  <form method="post" action="/request-cover" class="inline">
                    <input type="hidden" name="backto" value = "{{backto}}">
                    <input type="hidden" name="source" value = "{{source}}">
                    <input type="hidden" name="cover_by" value="{{ emp_id }}">
                    <input type="hidden" name="shift_cover" value="{{ shift_cover }}">
                    <input type="hidden" name="date" value="{{ date }}">
                    <input type="hidden" name="emp_id" value="{{ wants_emp_id }}">
                    <input type="hidden" name="coverage_status" value="covered">
                    <button class="bg-blue-500 text-white px-3 py-1 rounded text-xs hover:bg-blue-600">
                      Select
                    </button>
                  </form>
                {% endif %}
              </td>
              <td class="px-4 py-2">
                {% if not declined %}
                  {{ manager_OK_leave(me, title="Approved it with no cover",letype=source ) }}
                {% else %}
                  <span class="text-xs text-red-400 italic">Declined â€” override not available</span>
                {% endif %}
              </td>

            </tr>
          {% endfor %}

        </tbody>
      </table>
    {% else %}
      <p class="text-sm text-gray-500 italic mt-2">No suitable cover found for this shift.</p>
    {% endif %}
  </div>
{% endfor %}

{{ back_button() }}
{% endblock %}